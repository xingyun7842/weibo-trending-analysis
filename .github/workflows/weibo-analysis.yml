name: Weibo Trending Analysis

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤© UTC æ—¶é—´ 2:00 (åŒ—äº¬æ—¶é—´ 10:00)
  schedule:
    - cron: '0 2 * * *'

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      max_topics:
        description: 'åˆ†æžçƒ­ç‚¹æ•°é‡'
        required: false
        default: '15'

jobs:
  analyze-trends:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # å…è®¸æŽ¨é€ç”Ÿæˆçš„æŠ¥å‘Š
      pages: write     # å…è®¸éƒ¨ç½²åˆ° GitHub Pages
      id-token: write  # å…è®¸ OIDC token
      deployments: write  # å…è®¸åˆ›å»ºéƒ¨ç½²

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      - name: Run Weibo Analysis with Claude Agent SDK
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
          MAX_TOPICS: ${{ github.event.inputs.max_topics || '15' }}
        run: |
          python scripts/weibo_analysis_agent.py

      - name: Upload HTML Report as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: weibo-analysis-report-${{ github.run_number }}
          path: reports/*.html
          retention-days: 90

      - name: Commit and Push Report (Optional)
        if: success()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/*.html || true
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Add Weibo analysis report - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
          fi
        continue-on-error: true

      - name: Setup GitHub Pages
        if: success()
        uses: actions/configure-pages@v4

      - name: Upload Pages Artifact
        if: success()
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./reports

      - name: Deploy to GitHub Pages
        if: success()
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š å¾®åšçƒ­æœåˆ†æžå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ‰§è¡Œæ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**åˆ†æžçƒ­ç‚¹æ•°**: ${{ github.event.inputs.max_topics || '15' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“„ æŸ¥çœ‹æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ **åœ¨çº¿æŸ¥çœ‹**: https://xingyun7842.github.io/weibo-trending-analysis/" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”— **éƒ¨ç½²çŠ¶æ€**: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¥ **ä¸‹è½½æŠ¥å‘Š**: æŸ¥çœ‹ä¸‹æ–¹ Artifacts" >> $GITHUB_STEP_SUMMARY
